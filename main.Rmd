---
title: "Google Analytics Customer Revenue Prediction"
output: html_notebook
---

# Introdcution

A detailed analysis for Google Merchandise Store (also known as GStore, where Google swag is sold) customer dataset to predict revenue per customer. The goal is to enable marketing teams who analyze data on top of Google Analytics data to make more actionable operational changes and investment decisions.

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 

# Loading and Exploring Data

```{r }
# loading data from CSV files.
train <- read_csv("./data/input/train.csv")
test <- read_csv("./data/input/test.csv")
```
```{r results='hide'}
glimpse(train)
glimpse(test)
```

There are 12 features:

* **fullVisitorId** - an unique identifier for each user of the Google Merchandise Store
* **channelGrouping** - the channel via which the user came to the Store
* **date** - the date on which the user visited the Store
* **device** - the specifications for the device used to access the Store
* **geoNetwork** - this section contains information about the geography of the user
* **sessionId** - an unique identifier for this visit to the store
* **socialEngagementType** - engagement type, either "Socially Engaged" or "Not Socially Engaged"
* **totals** - this section contains aggregate values across the session
* **trafficSource** - this section contains information about the Traffic Source from which the session originated
* **visitId** - an identifier for this session
* **visitNumber** - the session number for this user
* **visitStartTime** - the timestamp (POSIX).

The columns device, geoNetwork, trafficSource, and totals are in JSON format. 
```{r echo=FALSE}
library(jsonlite)

flatten_json <- . %>%
  str_c(., collapse = ",") %>%
  str_c("[", .,"]") %>%
  fromJSON(flatten = T)

parse <- . %>%
  bind_cols(flatten_json(.$device)) %>%
  bind_cols(flatten_json(.$geoNetwork)) %>%
  bind_cols(flatten_json(.$trafficSource)) %>%
  bind_cols(flatten_json(.$totals)) %>%
  select(-device, -geoNetwork, -trafficSource, -totals)

train <- parse(train)
test <- parse(test)

```

## Removing the identification variables

We have two identification variables; sessionId, visitId, and fullVisitorId. We will keep the fullVisitorId as it is needed in our end result and will remove the others from training and testing data.

```{r}
library(tidyverse)
train <- train %>% select(-sessionId, -visitId)
test <- test %>% select(-sessionId, -visitId)
```

As expected from the description the transactionRevenue variable is exist in the train data only. However, there is another variable -campaingCode- in test data is not exist in the train data. Let's remove it.
```{r}
setdiff(names(train), names(test))
train["campaignCode"] <- NULL
```


## Finding and Removing Constant Variables

```{r echo= FALSE}
constant_features <- sapply(train, n_distinct)
cat("The constant features are: \n\n")
(deleted_cols = names(constant_features[constant_features == 1]))
train <- train %>% select(-one_of(deleted_cols))
test <- test %>% select(-one_of(deleted_cols))

rm(constant_features) 
rm(deleted_cols)

train %>%
  map_dfr(n_distinct) %>%
  gather() %>%
  ggplot(aes(reorder(key, -value), value)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  scale_y_log10(breaks = c(5, 50, 250, 500, 1000, 10000, 50000)) +
  geom_text(aes(label = value), vjust = 1.6, color = "white", size=3.5) +
  theme_minimal() +
  labs(x = "features", y = "Number of unique values") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

## Checking features format and its content

```{r}
glimpse(train)
```

During data observation, there is different representations for missing data. Let's convert them to NA.

```{r echo=FALSE}
is_na_val <- function(x) x %in% c("not available in demo dataset", "(not provided)","(not set)", "<NA>", "unknown.unknown","(none)") 

library(magrittr)
train %<>% mutate_all(funs(ifelse(is_na_val(.), NA, .)))
test %<>% mutate_all(funs(ifelse(is_na_val(.), NA, .)))

train %>%
  map_dfr(function(x) mean(is.na(x))) %>%
  gather() %>%
  ggplot(aes(reorder(key, -value), value)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  geom_text(aes(label = round(value, 3)), vjust = 1.6, color = "white", size=3) +
  theme_minimal() +
  coord_flip() + 
  labs(x = "features", y = "missing %") 

```
A lot of missing data in some variables!!


# Explore the target variable "transactionRevenue"

The transactionRevenue looks like it is multiplied by 10^6.

```{r}
y_rev <- as.numeric(train$transactionRevenue)
train$transactionRevenue <- NULL
summary(y_rev)
```
We can replce the *NA* with zero safely.
```{r}
y_rev %<>% replace_na(0)
summary(y_rev)
```

```{r echo=FALSE}
as_tibble(log1p(y_rev[y_rev > 0])) %>%
  ggplot(aes(x = value)) + 
  geom_histogram(bins = 30, fill = "steelblue") + 
  labs(x = "non-zero transaction revenue") + 
  theme_minimal()
```

The target variable distribution is right-skewed and it multiplied by 1e6. So, log-transormation will be used.

## Revenue Vs Channel Group Relation
```{r echo=FALSE}
train %>%
  bind_cols(as_tibble(y_rev)) %>%
  group_by(channelGrouping) %>%
  summarise(n = n(), total_rev = sum(value)) %>%
  arrange(desc(total_rev)) %>%
  ggplot(aes(x = reorder(channelGrouping, -total_rev), y = total_rev)) +
  geom_point() +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "Channel Grouping", y = "Total Revenue") 
```

Both **Social** and **Affilites** channels transactions don't generate revnue. The major revenue comes from **Referral** and **Direct** channels.

## Revenue Vs visitNumber Relation
  
```{r result='asis', message=FALSE, warning=FALSE, echo=FALSE}
train %>%
  bind_cols(as_tibble(log1p(y_rev))) %>%
  group_by(visitNumber) %>%
  summarise(log_total_rev = sum(value)) %>%
  ggplot(aes(x = visitNumber, y = log_total_rev)) +
  geom_point() +
  theme_minimal() +
  scale_x_continuous(breaks=c(1, 3, 5, 10, 15, 25, 50, 100), limits=c(0, 105))
  #scale_y_continuous()
  
```

Most of the revnue comes from the first visit.


```{r echo=FALSE}

# -------- channelGrouping ----------------- 
train %>% 
  bind_cols(as_tibble(y_rev)) %>% 
  group_by(channelGrouping) %>% 
  summarize(visits = n(), total_revenue = sum(value)) %>% 
  ungroup() %>% 
  mutate(channelGrouping = reorder(channelGrouping, -visits)) %>% 
  data.table::melt(id.vars = c("channelGrouping")) %>% 
  ggplot(aes(channelGrouping, value, fill = variable)) +
  geom_bar(stat = "identity") +
  scale_y_continuous(labels = scales::comma) +
  facet_wrap(~ variable, scales = "free") + 
  theme_minimal() +
  labs(x = "", y = "", title = "Visit and Revenue Distn over Channel Grouping") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position="none") 
# -------- browser ----------------- 
train %>% 
  bind_cols(as_tibble(y_rev)) %>% 
  mutate(browser = factor(browser) %>% fct_lump(prop=0.01)) %>% 
  group_by(browser) %>% 
  summarize(visits = n(), total_revenue = sum(value)) %>% 
  ungroup() %>% 
  mutate(browser = reorder(browser, -visits)) %>% 
  data.table::melt(id.vars = c("browser")) %>% 
  ggplot(aes(browser, value, fill = variable)) +
  geom_bar(stat = "identity") +
  scale_y_continuous(labels = scales::comma) +
  facet_wrap(~ variable, scales = "free") + 
  theme_minimal() +
  labs(x = "", y = "", title = "Visit and Revenue Distn over browser") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position="none") 
# -------- operatingSystem ----------------- 
train %>% 
  bind_cols(as_tibble(y_rev)) %>% 
  mutate(operatingSystem = factor(operatingSystem) %>% fct_lump(prop=0.01)) %>%
  group_by(operatingSystem) %>% 
  summarize(visits = n(), total_revenue = sum(value)) %>% 
  ungroup() %>% 
  mutate(operatingSystem = reorder(operatingSystem, -visits)) %>% 
  data.table::melt(id.vars = c("operatingSystem")) %>% 
  ggplot(aes(operatingSystem, value, fill = variable)) +
  geom_bar(stat = "identity") +
  scale_y_continuous(labels = scales::comma) +
  facet_wrap(~ variable, scales = "free") + 
  theme_minimal() +
  labs(x = "", y = "", title = "Visit and Revenue Distn over operatingSystem") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position="none") 
# -------- deviceCategory ----------------- 
train %>% 
  bind_cols(as_tibble(y_rev)) %>% 
  mutate(deviceCategory = factor(deviceCategory) %>% fct_lump(prop=0.01)) %>%
  group_by(deviceCategory) %>% 
  summarize(visits = n(), total_revenue = sum(value)) %>% 
  ungroup() %>% 
  mutate(deviceCategory = reorder(deviceCategory, -visits)) %>% 
  data.table::melt(id.vars = c("deviceCategory")) %>% 
  ggplot(aes(deviceCategory, value, fill = variable)) +
  geom_bar(stat = "identity") +
  scale_y_continuous(labels = scales::comma) +
  facet_wrap(~ variable, scales = "free") + 
  theme_minimal() +
  labs(x = "", y = "", title = "Visit and Revenue Distn over deviceCategory") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position="none") 
# -------- country ----------------- 
train %>% 
  bind_cols(as_tibble(y_rev)) %>% 
  mutate(country = factor(country) %>% fct_lump(prop=0.025)) %>%
  group_by(country) %>% 
  summarize(visits = n(), total_revenue = sum(value)) %>% 
  ungroup() %>% 
  mutate(country = reorder(country, -visits)) %>% 
  data.table::melt(id.vars = c("country")) %>% 
  ggplot(aes(country, value, fill = variable)) +
  geom_bar(stat = "identity") +
  scale_y_continuous(labels = scales::comma) +
  facet_wrap(~ variable, scales = "free") + 
  theme_minimal() +
  labs(x = "", y = "", title = "Visit and Revenue Distn over country") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position="none") 
# -------- city ----------------- 
train %>% 
  bind_cols(as_tibble(y_rev)) %>% 
  mutate(city = factor(city) %>% fct_lump(prop=0.01)) %>%
  group_by(city) %>% 
  summarize(visits = n(), total_revenue = sum(value)) %>% 
  ungroup() %>% 
  mutate(city = fct_explicit_na(city, na_level = "Other") %>% reorder(-visits)) %>%
  data.table::melt(id.vars = c("city")) %>% 
  ggplot(aes(city, value, fill = variable)) +
  geom_bar(stat = "identity") +
  scale_y_continuous(labels = scales::comma) +
  facet_wrap(~ variable, scales = "free") + 
  theme_minimal() +
  labs(x = "", y = "", title = "Visit and Revenue Distn over city") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position="none") 

# -------- networkDomain ----------------- 
train %>% 
  bind_cols(as_tibble(y_rev)) %>% 
  mutate(networkDomain = factor(networkDomain) %>% fct_lump(prop=0.01)) %>%
  group_by(networkDomain) %>% 
  summarize(visits = n(), total_revenue = sum(value)) %>% 
  ungroup() %>% 
  mutate(networkDomain = fct_explicit_na(networkDomain, na_level = "Other") %>% reorder(-visits)) %>%
  data.table::melt(id.vars = c("networkDomain")) %>% 
  ggplot(aes(networkDomain, value, fill = variable)) +
  geom_bar(stat = "identity") +
  scale_y_continuous(labels = scales::comma) +
  facet_wrap(~ variable, scales = "free") + 
  theme_minimal() +
  labs(x = "", y = "", title = "Visit and Revenue Distn over networkDomain") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position="none") 

# -------- medium ----------------- 
train %>% 
  bind_cols(as_tibble(y_rev)) %>% 
  mutate(medium = factor(medium) %>% fct_lump(prop=0.005)) %>%
  group_by(medium) %>% 
  summarize(visits = n(), total_revenue = sum(value)) %>% 
  ungroup() %>% 
  mutate(medium = fct_explicit_na(medium, na_level = "Other") %>% reorder(-visits)) %>%
  data.table::melt(id.vars = c("medium")) %>% 
  ggplot(aes(medium, value, fill = variable)) +
  geom_bar(stat = "identity") +
  scale_y_continuous(labels = scales::comma) +
  facet_wrap(~ variable, scales = "free") + 
  theme_minimal() +
  labs(x = "", y = "", title = "Visit and Revenue Distn over medium") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position="none") 
```

**Conclusions**:

* Majority of visits comes from **Organic Search**, while the majority of revenue comes from **Referral** channels.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Cmd+Shift+K* to preview the HTML file).
